import sqlite3
import pandas as pd
import json
import os # 1. os ì„í¬íŠ¸
from dotenv import load_dotenv # 2. load_dotenv ì„í¬íŠ¸
import google.generativeai as genai # Gemini API ë¼ì´ë¸ŒëŸ¬ë¦¬
import random

from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
import numpy as np

# --- 1. ì„¤ì • ---
DB_PATH = 'recipe_db.sqlite'

YOUR_API_KEY = os.getenv("GEMINI_API_KEY")

# ----------------------------------------------------
# [â˜…] ì¶”ì²œë°›ì„ ì‚¬ìš©ìë¥¼ IDë¡œ ì„ íƒí•˜ì„¸ìš” (1~5)
# (1: ê¹€ë‹¤ì´ì–´íŠ¸, 2: ë°•ë²Œí¬ì—…, 3: ì´ì±„ì‹, 4: ìµœë°”ì¨, 5: ì˜¤ì˜ì–‘)
# ----------------------------------------------------
TARGET_USER_ID = 2

# --- 2. DB ì ‘ê·¼ ë° í”„ë¡œí•„ íŒŒì‹± í•¨ìˆ˜ ---

def get_user_profile(conn, user_id):
    """'users' í…Œì´ë¸”ì—ì„œ íŠ¹ì • ì‚¬ìš©ì í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤."""
    try:
        profile_df = pd.read_sql(
            f"SELECT * FROM users WHERE user_id = {user_id}", 
            conn
        )
        if profile_df.empty: 
            print(f"ì˜¤ë¥˜: user_id {user_id}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            return None
        return profile_df.to_dict('records')[0]
    except Exception as e:
        print(f"í”„ë¡œí•„ ë¡œë“œ ì˜¤ë¥˜: {e}")
        return None

# -----------------------------------------------------------------
# [ì‹ ê·œ] 1ì°¨ í•„í„°ë§ì„ ìœ„í•œ 'ì§€ì‹ ë² ì´ìŠ¤ (Knowledge Base)'
# -----------------------------------------------------------------
# ì‚¬ìš©ìì˜ í”„ë¡œí•„ ìš©ì–´(Key)ë¥¼ ì‹¤ì œ ì¬ë£Œ í‚¤ì›Œë“œ(Value)ë¡œ 'ë²ˆì—­'
# ì´ ë§µì„ í™•ì¥í•˜ë©´ í• ìˆ˜ë¡ 1ì°¨ í•„í„°ë§ì´ ê°•ë ¥í•´ì§‘ë‹ˆë‹¤.
RESTRICTION_MAP = {
    # ==================================================
    # 1. í•œêµ­ í‘œì¤€ ì•Œë ˆë¥´ê¸° ìœ ë°œ ë¬¼ì§ˆ (19ì¢…)
    # ==================================================
    
    # --- 1. ë‚œë¥˜ (ì•Œë¥˜) ---
    'ë‚œë¥˜': ['ê³„ë€', 'ë‹¬ê±€', 'ë©”ì¶”ë¦¬ì•Œ', 'ê³„ë€ë§ì´', 'ì§€ë‹¨', 'ê³„ë€ì°œ', 'ìŠ¤í¬ë¨ë¸”', 'ì—ê·¸'],
    
    # --- 2. ìš°ìœ  ---
    'ìš°ìœ ': [
        'ìš°ìœ ', 'ìœ ì œí’ˆ', 'ì¹˜ì¦ˆ', 'ë²„í„°', 'ìš”ê±°íŠ¸', 'ìš”í”Œë ˆ', 'ìƒí¬ë¦¼', 'í¬ë¦¼', 
        'ë§ˆê°€ë¦°', 'ì—°ìœ ', 'ë¶„ìœ ', 'ì¹´ì œì¸', 'ìœ ì²­', 'ì‚¬ì›Œí¬ë¦¼', 'í¬ë¦¼ì¹˜ì¦ˆ'
    ],
    
    # --- 3. ë©”ë°€ ---
    'ë©”ë°€': ['ë©”ë°€', 'ë©”ë°€êµ­ìˆ˜', 'ë©”ë°€ê°€ë£¨', 'ë©”ë°€ë¬µ'],
    
    # --- 4. ë•…ì½© ---
    'ë•…ì½©': ['ë•…ì½©', 'í”¼ë„›', 'ë•…ì½©ë²„í„°', 'ë•…ì½©ê°€ë£¨'],
    
    # --- 5. ëŒ€ë‘ ---
    'ëŒ€ë‘': [
        'ëŒ€ë‘', 'ì½©', 'ë‘ë¶€', 'ëœì¥', 'ê°„ì¥', 'ê³ ì¶”ì¥', 'ì²­êµ­ì¥', 'ì½©ë‚˜ë¬¼', 'ìˆœë‘ë¶€', 
        'ìœ ë¶€', 'ì½©ê°€ë£¨', 'ë‘ìœ ', 'ì¶˜ì¥', 'ë¯¸ì†Œ', 'í…œí˜', 'ì½©ê¸°ë¦„'
    ],
    
    # --- 6. ë°€ ---
    'ë°€': [
        'ë°€', 'ë°€ê°€ë£¨', 'ë¶€ì¹¨ê°€ë£¨', 'ë¹µê°€ë£¨', 'ìˆ˜ì œë¹„', 'ì¹¼êµ­ìˆ˜', 'ë©´', 'íŒŒìŠ¤íƒ€', 
        'ë¼ë©´', 'êµ­ìˆ˜', 'ìŠ¤íŒŒê²Œí‹°', 'ë¹µ', 'ì¼€ì´í¬', 'ì‹œë¦¬ì–¼', 'ê¸€ë£¨í…', 'ë˜ë ì•„'
    ],
    
    # --- 7. ì£ ---
    'ì£': ['ì£', 'ì£ê°€ë£¨'],
    
    # --- 8. í˜¸ë‘ ---
    'í˜¸ë‘': ['í˜¸ë‘', 'ì›”ë„›', 'í˜¸ë‘ê³¼ì'],
    
    # --- 9. ê²Œ ---
    'ê²Œ': ['ê²Œ', 'í¬ë©', 'ê½ƒê²Œ', 'ëŒ€ê²Œ', 'í‚¹í¬ë©', 'ê²Œë§›ì‚´', 'ë§›ì‚´'],
    
    # --- 10. ìƒˆìš° ---
    'ìƒˆìš°': ['ìƒˆìš°', 'ëŒ€í•˜', 'ìƒˆìš°ì “', 'í¬ë¦´', 'ì¹µí…Œì¼ìƒˆìš°', 'ê±´ìƒˆìš°', 'ê¹ìƒˆìš°'],
    
    # --- 11. ì˜¤ì§•ì–´ ---
    'ì˜¤ì§•ì–´': ['ì˜¤ì§•ì–´', 'ê¼´ëšœê¸°', 'ë¬¼ì˜¤ì§•ì–´', 'ë§ˆë¥¸ì˜¤ì§•ì–´', 'ì˜¤ì§•ì–´ì±„'],
    
    # --- 12. ê³ ë“±ì–´ ---
    'ê³ ë“±ì–´': ['ê³ ë“±ì–´', 'ì‚¼ì¹˜', 'ë°©ì–´'], # ë“±í‘¸ë¥¸ ìƒì„ 
    
    # --- 13. ì¡°ê°œë¥˜ ---
    'ì¡°ê°œë¥˜': [
        'ì¡°ê°œ', 'êµ´', 'ì „ë³µ', 'í™í•©', 'ê°€ë¦¬ë¹„', 'ë°”ì§€ë½', 'ê¼¬ë§‰', 'ì†Œë¼', 'í‚¤ì¡°ê°œ', 
        'ë°±í•©', 'ë™ì£½', 'ì¬ì²©', 'ê´€ì'
    ],
    
    # --- 14. ë³µìˆ­ì•„ ---
    'ë³µìˆ­ì•„': ['ë³µìˆ­ì•„', 'í™©ë„', 'ë°±ë„', 'ë„¥íƒ€ë¦°'],
    
    # --- 15. í† ë§ˆí†  ---
    'í† ë§ˆí† ': ['í† ë§ˆí† ', 'ë°©ìš¸í† ë§ˆí† ', 'ì¼€ì²©', 'í† ë§ˆí† ì†ŒìŠ¤', 'í† ë§ˆí† í˜ì´ìŠ¤íŠ¸', 'íŒŒìŠ¤íƒ€ì†ŒìŠ¤'],
    
    # --- 16. ë‹­ê³ ê¸° ---
    'ë‹­ê³ ê¸°': [
        'ë‹­', 'ì¹˜í‚¨', 'ë‹­ê°€ìŠ´ì‚´', 'ë‹­ë‹¤ë¦¬', 'ë‹­ë°œ', 'ë‹­ë‚ ê°œ', 'ì‚¼ê³„íƒ•', 'ë‹­ë³¶ìŒíƒ•', 
        'ë‹­ê°ˆë¹„', 'ë‹­ê°•ì •', 'ë‹­ê¼¬ì¹˜'
    ],
    
    # --- 17. ë¼ì§€ê³ ê¸° ---
    'ë¼ì§€ê³ ê¸°': [
        'ë¼ì§€', 'ëˆìœ¡', 'ë“±ë¼ˆ', 'ë² ì´ì»¨', 'í–„', 'ì†Œì‹œì§€', 'ì‚¼ê²¹ì‚´', 'ëª©ì‚´', 'í•­ì •ì‚´', 
        'ì¡±ë°œ', 'ìˆ˜ìœ¡', 'ë“±ì‹¬', 'ì•ˆì‹¬', 'ê°ˆë§¤ê¸°ì‚´', 'ì•ë‹¤ë¦¬ì‚´', 'ë’·ë‹¤ë¦¬ì‚´'
    ],
    
    # --- 18. ì‡ ê³ ê¸° (ì†Œê³ ê¸°) ---
    'ì‡ ê³ ê¸°': [
        'ì†Œ', 'ì‡ ', 'í•œìš°', 'ìœ¡ìš°', 'ìš°ì‚¼ê²¹', 'ê°ˆë¹„', 'ì‚¬ê³¨', 'ì†Œê¼¬ë¦¬', 'ì–‘ì§€', 
        'ì°¨ëŒë°•ì´', 'ë¶ˆê³ ê¸°ê°', 'ë“±ì‹¬', 'ì•ˆì‹¬', 'ì±„ë', 'ì„¤ë„', 'ìš°ë‘”', 'ìœ¡íšŒ'
    ],
    
    # --- 19. ì•„í™©ì‚°ë¥˜ ---
    'ì•„í™©ì‚°ë¥˜': ['ì™€ì¸', 'ê±´í¬ë„', 'ê±´ê³¼ì¼', 'í‘œë°±ì œ', 'ë³´ì¡´ì œ', 'ì•„í™©ì‚°ë‚˜íŠ¸ë¥¨'], # ì‹í’ˆì²¨ê°€ë¬¼ë¡œ ì£¼ë¡œ ì‚¬ìš©ë¨

    # ==================================================
    # 2. ìœ ìš©í•œ ì¢…í•© ì¹´í…Œê³ ë¦¬
    # ==================================================
    
    # --- ê²¬ê³¼ë¥˜ ì¢…í•© ---
    'ê²¬ê³¼ë¥˜': [
        'ë•…ì½©', 'í”¼ë„›', 'ë•…ì½©ë²„í„°', 'ì£', 'í˜¸ë‘', 'ì›”ë„›', 'ì•„ëª¬ë“œ', 'ìºìŠˆë„›', 
        'ë§ˆì¹´ë‹¤ë¯¸ì•„', 'í”¼ìŠ¤íƒ€ì¹˜ì˜¤', 'í—¤ì´ì¦ë„›', 'ê²¬ê³¼'
    ],

    # --- ê°‘ê°ë¥˜ ì¢…í•© (ê²Œ + ìƒˆìš°) ---
    'ê°‘ê°ë¥˜': [
        'ê²Œ', 'í¬ë©', 'ê½ƒê²Œ', 'ë§›ì‚´', 'ìƒˆìš°', 'ëŒ€í•˜', 'ìƒˆìš°ì “', 'ê°€ì¬', 'ëìŠ¤í„°', 
        'í¬ë¦´'
    ],

    # --- ìƒì„ /ì–´ë¥˜ ì¢…í•© ---
    'ìƒì„ ': [
        'ìƒì„ ', 'ê³ ë“±ì–´', 'ê°ˆì¹˜', 'ì¡°ê¸°', 'ì°¸ì¹˜', 'ì—°ì–´', 'ê½ì¹˜', 'ìƒíƒœ', 'ëª…íƒœ', 'ë™íƒœ', 
        'í™©íƒœ', 'ë¶ì–´', 'ì½”ë‹¤ë¦¬', 'ì„ì—°ìˆ˜', 'ê°€ìë¯¸', 'ì‚¼ì¹˜', 'ë°©ì–´', 'ì „ì–´', 'ë©¸ì¹˜'
    ],

    # --- í•´ì‚°ë¬¼ ì¢…í•© (ìƒì„  + ê°‘ê°ë¥˜ + ì¡°ê°œë¥˜ + ê¸°íƒ€) ---
    'í•´ì‚°ë¬¼': [
        # ìƒì„ 
        'ìƒì„ ', 'ê³ ë“±ì–´', 'ê°ˆì¹˜', 'ì¡°ê¸°', 'ì°¸ì¹˜', 'ì—°ì–´', 'ê½ì¹˜', 'ìƒíƒœ', 'ëª…íƒœ', 'ë™íƒœ', 
        'í™©íƒœ', 'ë¶ì–´', 'ì½”ë‹¤ë¦¬', 'ë©¸ì¹˜',
        # ê°‘ê°ë¥˜
        'ê²Œ', 'í¬ë©', 'ê½ƒê²Œ', 'ë§›ì‚´', 'ìƒˆìš°', 'ëŒ€í•˜', 'ìƒˆìš°ì “', 'ê°€ì¬', 'ëìŠ¤í„°',
        # ì¡°ê°œë¥˜
        'ì¡°ê°œ', 'êµ´', 'ì „ë³µ', 'í™í•©', 'ê°€ë¦¬ë¹„', 'ë°”ì§€ë½', 'ê¼¬ë§‰', 'ì†Œë¼',
        # ê¸°íƒ€
        'ì–´ë¬µ', 'í•´ë¬¼', 'ì˜¤ì§•ì–´', 'ë¬¸ì–´', 'ì­ˆê¾¸ë¯¸', 'ë‚™ì§€', 'ê¼´ëšœê¸°', 'ë©ê²Œ', 'í•´ì‚¼', 'ë‚ ì¹˜ì•Œ'
    ],

    # --- ìœ¡ë¥˜ ì¢…í•© (ë¼ì§€ + ì†Œ + ë‹­ + ê¸°íƒ€) ---
    'ìœ¡ë¥˜': [
        # ë¼ì§€
        'ë¼ì§€', 'ëˆìœ¡', 'ë² ì´ì»¨', 'í–„', 'ì†Œì‹œì§€', 'ì‚¼ê²¹ì‚´', 'ëª©ì‚´', 'ì¡±ë°œ', 'ìˆ˜ìœ¡',
        # ì†Œ
        'ì†Œ', 'ì‡ ', 'í•œìš°', 'ìœ¡ìš°', 'ê°ˆë¹„', 'ì‚¬ê³¨', 'ì†Œê¼¬ë¦¬', 'ì°¨ëŒë°•ì´', 'ë¶ˆê³ ê¸°ê°', 'ìœ¡íšŒ',
        # ë‹­
        'ë‹­', 'ì¹˜í‚¨', 'ë‹­ê°€ìŠ´ì‚´', 'ë‹­ë‹¤ë¦¬', 'ì‚¼ê³„íƒ•', 'ë‹­ë³¶ìŒíƒ•',
        # ê¸°íƒ€
        'ì˜¤ë¦¬', 'ì–‘', 'ì—¼ì†Œ', 'ìœ¡ë¥˜', 'ê³ ê¸°'
    ],
    
    # ==================================================
    # 3. íŠ¹ìˆ˜ ì‹ì´ ì œí•œ (ì±„ì‹ ë“±)
    # ==================================================

    # --- ì±„ì‹ (Vegetarian) ---
    'ì±„ì‹': [
        # ìœ¡ë¥˜
        'ë¼ì§€', 'ëˆìœ¡', 'ë² ì´ì»¨', 'í–„', 'ì†Œì‹œì§€', 'ì‚¼ê²¹ì‚´', 'ì†Œ', 'ì‡ ', 'í•œìš°', 'ìœ¡ìš°', 'ê°ˆë¹„', 'ì‚¬ê³¨',
        'ë‹­', 'ì¹˜í‚¨', 'ì˜¤ë¦¬', 'ì–‘', 'ìœ¡ë¥˜', 'ê³ ê¸°',
        # ì–´ë¥˜
        'ìƒì„ ', 'ê³ ë“±ì–´', 'ê°ˆì¹˜', 'ì¡°ê¸°', 'ì°¸ì¹˜', 'ì—°ì–´', 'ê½ì¹˜', 'ìƒíƒœ', 'ëª…íƒœ', 'ë™íƒœ', 'í™©íƒœ', 'ë¶ì–´',
        # í•´ì‚°ë¬¼
        'ì–´ë¬µ', 'ë§›ì‚´', 'í•´ë¬¼', 'í•´ì‚°ë¬¼', 'ì˜¤ì§•ì–´', 'ë¬¸ì–´', 'ì¡°ê°œ', 'êµ´', 'ì „ë³µ', 'í™í•©', 'ì­ˆê¾¸ë¯¸', 'ë‚™ì§€',
        # ìˆ¨ì€ ë™ë¬¼ì„± ì¬ë£Œ (CSV ìƒ˜í”Œ í™•ì¸ í›„ ê°•í™”)
        'ë©¸ì¹˜', 'ì•¡ì “', 'ê¹Œë‚˜ë¦¬', 'ìƒˆìš°ì “', 'ìœ¡ìˆ˜', 'ìŠ¤í†¡', 'ë‹¤ì‹œë‹¤', 'ì‚¬ê³¨ìœ¡ìˆ˜', 'ë©¸ì¹˜ìœ¡ìˆ˜', 
        'ì¹˜í‚¨ìŠ¤í†¡', 'ë¹„í”„ìŠ¤í†¡', 'ì½”ì¸ìœ¡ìˆ˜', 'í•œì•Œìœ¡ìˆ˜' # 'ìœ¡ìˆ˜' í‚¤ì›Œë“œ ìì²´ê°€ ê°•ë ¥í•˜ê²Œ ì‘ìš©
    ],
    
    # --- ë¹„ê±´ (Vegan) ---
    'ë¹„ê±´': [
        # ì±„ì‹ í‚¤ì›Œë“œ ëª¨ë‘ í¬í•¨
        'ë¼ì§€', 'ëˆìœ¡', 'ë² ì´ì»¨', 'í–„', 'ì†Œì‹œì§€', 'ì‚¼ê²¹ì‚´', 'ì†Œ', 'ì‡ ', 'í•œìš°', 'ìœ¡ìš°', 'ê°ˆë¹„', 'ì‚¬ê³¨',
        'ë‹­', 'ì¹˜í‚¨', 'ì˜¤ë¦¬', 'ì–‘', 'ìœ¡ë¥˜', 'ìƒì„ ', 'ê³ ë“±ì–´', 'ê°ˆì¹˜', 'ì¡°ê¸°', 'ì°¸ì¹˜', 'ì—°ì–´', 'ê½ì¹˜', 'ìƒíƒœ',
        'ëª…íƒœ', 'ë™íƒœ', 'í™©íƒœ', 'ë¶ì–´', 'ì–´ë¬µ', 'ë§›ì‚´', 'í•´ë¬¼', 'í•´ì‚°ë¬¼', 'ì˜¤ì§•ì–´', 'ë¬¸ì–´', 'ì¡°ê°œ', 'êµ´',
        'ì „ë³µ', 'í™í•©', 'ì­ˆê¾¸ë¯¸', 'ë‚™ì§€', 'ë©¸ì¹˜', 'ì•¡ì “', 'ê¹Œë‚˜ë¦¬', 'ìƒˆìš°ì “', 'ìœ¡ìˆ˜', 'ìŠ¤í†¡', 'ë‹¤ì‹œë‹¤', 
        'ì‚¬ê³¨ìœ¡ìˆ˜', 'ë©¸ì¹˜ìœ¡ìˆ˜', 'ì¹˜í‚¨ìŠ¤í†¡',
        # ìœ ì œí’ˆ/ë‚œë¥˜
        'ê³„ë€', 'ë‹¬ê±€', 'ë©”ì¶”ë¦¬ì•Œ', 'ë‚œë¥˜', 'ì•Œ',
        'ìš°ìœ ', 'ì¹˜ì¦ˆ', 'ë²„í„°', 'ìš”ê±°íŠ¸', 'ìƒí¬ë¦¼', 'ìœ ì œí’ˆ', 'í¬ë¦¼',
        # ê¸°íƒ€ ë™ë¬¼ì„±
        'ê¿€', 'ì ¤ë¼í‹´'
    ]
}

# -----------------------------------------------------------------
# [ê°•í™”ëœ] 1ì°¨ í•„í„°ë§ í•¨ìˆ˜
# -----------------------------------------------------------------

def parse_restrictions(profile):
    """
    (ê°•í™”) í”„ë¡œí•„ì„ 'ë²ˆì—­ ë§µ(RESTRICTION_MAP)'ì„ ì‚¬ìš©í•´
    ì‹¤ì œ í•„í„°ë§í•  í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    """
    
    # ì¤‘ë³µ í‚¤ì›Œë“œë¥¼ ìë™ìœ¼ë¡œ ì œê±°í•˜ê¸° ìœ„í•´ set ì‚¬ìš©
    final_keyword_set = set()
    
    # --- 1. DB í”„ë¡œí•„ì—ì„œ ì›ì‹œ ì œì•½ì–´ ì¶”ì¶œ ---
    raw_allergies = profile['restrictions_allergies']
    raw_other = profile['restrictions_other']
    
    all_raw_terms = []
    if raw_allergies != 'ì—†ìŒ':
        all_raw_terms.extend([term.strip() for term in raw_allergies.split(',')])
        
    if raw_other != 'ì—†ìŒ':
        # 'ì¢…êµ(ë¼ì§€ê³ ê¸° x)' -> 'ë¼ì§€ê³ ê¸°' ì¶”ì¶œ
        if 'ë¼ì§€ê³ ê¸°' in raw_other:
            all_raw_terms.append('ë¼ì§€ê³ ê¸°')
        if 'ì´ìŠ¬ëŒêµ' in raw_other:
            all_raw_terms.append('ë¼ì§€ê³ ê¸°')
        if 'íŒë‘êµ' in raw_other:
            all_raw_terms.append('ì†Œê³ ê¸°')
        # 'ì±„ì‹, ë¹„ê±´' -> 'ì±„ì‹', 'ë¹„ê±´' ì¶”ì¶œ
        if 'ì±„ì‹' in raw_other:
            all_raw_terms.append('ì±„ì‹')
        if 'ë¹„ê±´' in raw_other:
            all_raw_terms.append('ë¹„ê±´')
    
    # --- 2. 'ë²ˆì—­ ë§µ'ì„ ì‚¬ìš©í•´ í‚¤ì›Œë“œ í™•ì¥ ---
    # (ì˜ˆ: 'ê²Œ' -> ['ê²Œ', 'í¬ë©', 'ê½ƒê²Œ', 'ë§›ì‚´'])
    
    # ì¤‘ë³µëœ ì›ì‹œ ì œì•½ì–´ ì œê±° (ì˜ˆ: ì´ì±„ì‹ì€ ì•Œë ˆë¥´ê¸°ì— 'ë‹­ê³ ê¸°', ì œì•½ì— 'ì±„ì‹'ì´ ë‘˜ ë‹¤ ìˆìŒ)
    unique_raw_terms = list(set(all_raw_terms))
    
    for term in unique_raw_terms:
        if term in RESTRICTION_MAP:
            # ë§µì— ì •ì˜ëœ í‚¤ì›Œë“œ ë¬¶ìŒì„ ì¶”ê°€
            final_keyword_set.update(RESTRICTION_MAP[term])
        else:
            # ë§µì— ì—†ëŠ” ë‹¨ì–´(ì˜ˆ: ë³µìˆ­ì•„)ëŠ” ì›ë³¸ ë‹¨ì–´ ìì²´ë¥¼ í‚¤ì›Œë“œë¡œ ì¶”ê°€
            final_keyword_set.add(term)
            
    final_list = list(final_keyword_set)
    
    # [ë¡œê·¸ ê°•í™”] ëª‡ ê°œì˜ í‚¤ì›Œë“œê°€ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
    print(f"âœ… (1ì°¨-ê°•í™”) í”„ë¡œí•„ ìš©ì–´ {unique_raw_terms}(ìœ¼)ë¡œë¶€í„°")
    print(f"   -> ì´ {len(final_list)}ê°œì˜ ê¸ˆì§€ ì¬ë£Œ í‚¤ì›Œë“œë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤.")
    # (ë„ˆë¬´ ê¸¸ë©´ ì¼ë¶€ë§Œ ì¶œë ¥)
    if len(final_list) > 20:
        print(f"   (ì˜ˆ: {final_list[:20]}...)")
    else:
        print(f"   -> {final_list}")
        
    return final_list

def recommend_recipes_by_filter(conn, profile, restrictions):
    """
    (1ì°¨ í•„í„°ë§) 'recipes' í…Œì´ë¸”ì—ì„œ ê¸ˆì§€ ì¬ë£Œ + ì‹œê°„ ì œì•½ì„ í•„í„°ë§í•©ë‹ˆë‹¤.
    (ì´ í•¨ìˆ˜ëŠ” ì…ë ¥(restrictions)ì´ ê°•ë ¥í•´ì¡Œìœ¼ë¯€ë¡œ, ë¡œì§ ìˆ˜ì •ì€ ê±°ì˜ í•„ìš” ì—†ìŒ)
    """
    try:
        # DBì—ì„œ ëª¨ë“  ë ˆì‹œí”¼ ë¡œë“œ (AIë¡œ ì‹œê°„ ì±„ìš°ê¸° ì „ ì›ë³¸ DB)
        # (ë§Œì•½ 1ë‹¨ê³„ì—ì„œ recipes_imputed_xgb.csvë¥¼ DBì— ë®ì–´ì¼ë‹¤ë©´
        #  CKG_TIME_NMì„ ì—¬ê¸°ì„œ í•„í„°ë§í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤)
        
        # [ì°¸ê³ ] recipes_imputed_xgb.csvë¥¼ DBì— ë®ì–´ì“°ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ
        # 1ë‹¨ê³„ì˜ ì›ë³¸ DB(recipes)ë¥¼ ì½ì–´ì˜¤ëŠ” ê²ƒì´ ë§ìŠµë‹ˆë‹¤.
        all_recipes_df = pd.read_sql("SELECT * FROM recipes", conn)
        
        # --- 1. ì¬ë£Œ í•„í„°ë§ ---
        filtered_indices = [] # í•©ê²©í•œ ë ˆì‹œí”¼ì˜ ì¸ë±ìŠ¤
        
        for index, row in all_recipes_df.iterrows():
            
            # [ìˆ˜ì •] ë” êµ¬ì²´ì ì¸ ì˜ˆì™¸ ì²˜ë¦¬
            try:
                # ingredients_json ì»¬ëŸ¼ì˜ ë¬¸ìì—´ì„ ë”•ì…”ë„ˆë¦¬ë¡œ ë³€í™˜
                ingredients_dict = json.loads(row['ingredients_json'])
            except (json.JSONDecodeError, TypeError):
                # JSON í˜•ì‹ì´ ì•„ë‹ˆê±°ë‚˜ NaNì¸ ê²½ìš°, ì•ˆì „í•˜ê²Œ í•„í„°ë§(ì œì™¸)
                continue 
                
            ingredient_names = ingredients_dict.keys()
            
            is_safe = True # ì¼ë‹¨ ì•ˆì „í•˜ë‹¤ê³  ê°€ì •
            for restriction in restrictions:
                for name in ingredient_names:
                    # [í•µì‹¬ ë¡œì§] 'ë©¸ì¹˜'ê°€ 'êµ­ë¬¼ìš© ë©¸ì¹˜'ì— í¬í•¨ë˜ëŠ”ì§€ ê²€ì‚¬
                    if restriction in name:
                        is_safe = False 
                        break 
                if not is_safe:
                    break 
            
            if is_safe:
                filtered_indices.append(index)
                
        material_filtered_df = all_recipes_df.loc[filtered_indices]
        print(f"âœ… (1ì°¨-ì¬ë£Œ) {len(all_recipes_df)}ê°œ ì¤‘ {len(material_filtered_df)}ê°œ ë ˆì‹œí”¼ê°€ ì•ˆì „í•©ë‹ˆë‹¤.")
        
        # -----------------------------------------------------------------
        # [ìˆ˜ì •ëœ ë¶€ë¶„] 2. ì‹œê°„ í•„í„°ë§ (30ë¶„ / 60ë¶„ ì œì•½ ì²˜ë¦¬)
        # -----------------------------------------------------------------
        
        other_restrictions = profile['restrictions_other']
        allowed_times = []
        time_limit_str = "ì œì•½ ì—†ìŒ"

        if 'ì¡°ë¦¬ì‹œê°„ 30ë¶„ ì´ë‚´' in other_restrictions:
            # 30ë¶„ ì œì•½ì´ ê±¸ë¦¬ë©´, 60ë¶„ ì œì•½ì€ ë¬´ì‹œ (ë” ê°•ë ¥í•œ ì¡°ê±´)
            allowed_times = ['30ë¶„ì´ë‚´', '15ë¶„ì´ë‚´', '10ë¶„ì´ë‚´', '5ë¶„ì´ë‚´']
            time_limit_str = "30ë¶„ ì´ë‚´"
            
        elif 'ì¡°ë¦¬ì‹œê°„ 60ë¶„ ì´ë‚´' in other_restrictions:
            # 30ë¶„ ì œì•½ì€ ì—†ì§€ë§Œ 60ë¶„ ì œì•½ì´ ìˆëŠ” ê²½ìš°
            allowed_times = ['60ë¶„ì´ë‚´', '30ë¶„ì´ë‚´', '15ë¶„ì´ë‚´', '10ë¶„ì´ë‚´', '5ë¶„ì´ë‚´']
            time_limit_str = "60ë¶„ ì´ë‚´"
        
        # allowed_times ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆì§€ ì•Šë‹¤ë©´ (ì¦‰, ì‹œê°„ ì œì•½ì´ ìˆë‹¤ë©´)
        if allowed_times:
            print(f"ì‹œê°„ ì œì•½({time_limit_str})ìœ¼ë¡œ í•„í„°ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤...")
            
            # CKG_TIME_NM ì»¬ëŸ¼ê°’ì´ allowed_times ë¦¬ìŠ¤íŠ¸ì— í¬í•¨ëœ ê²ƒë§Œ ì„ íƒ
            # (DB ì›ë³¸ì˜ NaN ê°’ì€ isin()ì—ì„œ ìë™ìœ¼ë¡œ False ì²˜ë¦¬ë˜ì–´ ì œì™¸ë¨)
            final_filtered_df = material_filtered_df[
                material_filtered_df['CKG_TIME_NM'].isin(allowed_times)
            ]
            print(f"âœ… (1ì°¨-ì‹œê°„) {len(final_filtered_df)}ê°œ ë ˆì‹œí”¼ë§Œ ë‚¨ê¹€.")
        else:
            # ì‹œê°„ ì œì•½ì´ ì—†ìœ¼ë©´(allowed_timesê°€ ë¹„ì–´ìˆìœ¼ë©´) ì¬ë£Œ í•„í„°ë§ ê²°ê³¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            print("ì‹œê°„ ì œì•½ ì—†ìŒ. ì¬ë£Œ í•„í„°ë§ ê²°ê³¼ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.")
            final_filtered_df = material_filtered_df
        
        # ---------------------------------------------------------
        # [ìˆ˜ì •] 3. ì˜ˆì‚° í•„í„°ë§ (ì •ì  ìˆ«ì budget ì‚¬ìš©)
        # ---------------------------------------------------------
        user_budget = profile.get('budget', 0) # DBì—ì„œ ê°€ì ¸ì˜¨ ìˆ«ì (ì—†ìœ¼ë©´ 0)
    
        if user_budget and user_budget > 0:
            # [ì „ëµ] ë„¤ì´ë²„ ê°€ê²©ì€ 'ëŒ€ìš©ëŸ‰(ë¬¶ìŒ)' ê¸°ì¤€ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, 
            # í•œ ë¼ ì˜ˆì‚°(user_budget)ì˜ 2ë°°ê¹Œì§€ëŠ” í›„ë³´êµ°ì— í¬í•¨ì‹œì¼œ ì¤ë‹ˆë‹¤.
            # (ì˜ˆ: ë‚´ ì˜ˆì‚° 1ë§Œì› -> ì¬ë£Œë¹„ í•©ê³„ 2ë§Œì›ì§œë¦¬(ëŒ€ìš©ëŸ‰) ë ˆì‹œí”¼ë„ ì¼ë‹¨ í†µê³¼)
            budget_limit = user_budget * 2 
        
            final_filtered_df = final_filtered_df[
                (final_filtered_df['estimated_price'] <= budget_limit) | 
                (final_filtered_df['estimated_price'].isnull()) |
                (final_filtered_df['estimated_price'] == 0)
            ]
            print(f"ğŸ’° (1ì°¨-ì˜ˆì‚°) {user_budget:,}ì› ì˜ˆì‚° ì ìš© -> ëŒ€ìš©ëŸ‰ ê¸°ì¤€ {budget_limit:,}ì› ì´í•˜ {len(final_filtered_df)}ê°œ ë‚¨ê¹€.")
    
        else:
            print("ğŸ’° (1ì°¨-ì˜ˆì‚°) ì˜ˆì‚° ì œì•½ ì—†ìŒ.")
        
        return final_filtered_df
    
    except Exception as e:
        print(f"í•„í„°ë§ ì¤‘ ì˜¤ë¥˜: {e}")
        return pd.DataFrame()
# --- 3. (ì‹ ê·œ) 4ë‹¨ê³„: Gemini API í˜¸ì¶œ í•¨ìˆ˜ (ìˆ˜ì •ëœ ë²„ì „) ---

def get_gemini_recommendation(api_key, profile, candidate_recipes, today_str, mood, free_text):
    """
    (2ì°¨ ì¶”ì²œ) ë™ì  í”„ë¡¬í”„íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ Gemini APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
    """
    try:
        genai.configure(api_key=api_key)
        
        model = genai.GenerativeModel('models/gemini-flash-latest')
        
        # í›„ë³´ ë ˆì‹œí”¼ ëª©ë¡ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
        recipe_list_str = "\n".join([
            f"- {row['RCP_TTL']} (ì¡°ë¦¬ë²•: {row['CKG_MTH_ACTO_NM']}, ì†Œìš”ì‹œê°„: {row['CKG_TIME_NM']})"
            for _, row in candidate_recipes.iterrows()
        ])
        
        # ì‚¬ìš©ì í”„ë¡œí•„ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
        profile_str = f"""
        - ì‚¬ìš©ìëª…: {profile['username']}
        - ì„ í˜¸ ìŒì‹: {profile['preferences']}
        - ë‹¬ì„± ëª©í‘œ: {profile['goals']}
        - (ì°¸ê³ ) ê¸°íƒ€ ì œì•½: {profile['restrictions_other']}
        """

        # 4-1. 'ì˜¤ëŠ˜ì˜ ì»¨í…ìŠ¤íŠ¸' ë¬¸ìì—´ ìƒì„±
        context_str = f"- ì˜¤ëŠ˜ì€ {today_str}ì…ë‹ˆë‹¤."
        
        # 4-2. ê¸°ë¶„
        if mood != "-": # '-'ê°€ ì•„ë‹ˆë©´ (ì¦‰, ì‚¬ìš©ìê°€ ê¸°ë¶„ì„ ì„ íƒí–ˆìœ¼ë©´)
            context_str += f"\n- ì‚¬ìš©ìì˜ í˜„ì¬ ê¸°ë¶„: {mood}"
            
        # 4-3. ììœ¨ ì…ë ¥
        if free_text: # ì…ë ¥ê°’ì´ ìˆìœ¼ë©´
            context_str += f"\n- ì‚¬ìš©ìì˜ ì¶”ê°€ ìš”ì²­: {free_text}"
        else:
            context_str += "\n- ì‚¬ìš©ìì˜ ì¶”ê°€ ìš”ì²­: ì—†ìŒ"


        # [ìˆ˜ì •] ìµœì¢… í”„ë¡¬í”„íŠ¸ (ìƒˆë¡œìš´ [ì˜¤ëŠ˜ì˜ ì»¨í…ìŠ¤íŠ¸] ì„¹ì…˜ ì¶”ê°€)
        prompt = f"""
        ë‹¹ì‹ ì€ BobFitì˜ ì‹ë‹¨ ì½”ì¹˜ ì „ë¬¸ ì˜ì–‘ì‚¬ì…ë‹ˆë‹¤. 
        '{profile['username']}' ë‹˜ì„ ìœ„í•œ ì˜¤ëŠ˜ì˜ ì‹ë‹¨ í›„ë³´(ì•„ì¹¨/ì ì‹¬/ì €ë…)ë¥¼ ì¶”ì²œí•´ì•¼ í•©ë‹ˆë‹¤.

        [ì‚¬ìš©ì í”„ë¡œí•„]
        {profile_str}

        [ì˜¤ëŠ˜ì˜ ì»¨í…ìŠ¤íŠ¸]
        {context_str}

        [ì¶”ì²œ ëŒ€ìƒ ë ˆì‹œí”¼ í›„ë³´ ëª©ë¡ (ìµœëŒ€ 100ê°œ)]
        {recipe_list_str}

        [ìš”ì²­ ì‚¬í•­]
        1. [ì˜¤ëŠ˜ì˜ ì»¨í…ìŠ¤íŠ¸]ë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•˜ì—¬ ì¶”ì²œí•´ì£¼ì„¸ìš”.
           (ì˜ˆ: "í”¼ê³¤í•¨" ìƒíƒœë©´ 'ì´ˆê°„ë‹¨í•œ í•œ ë¼'ë¥¼, "ë¹„ ì˜¤ëŠ” ë‚ " ìš”ì²­ì´ ìˆìœ¼ë©´ 'ë”°ëœ»í•œ êµ­ë¬¼' ìš”ë¦¬ë¥¼ ìš°ì„  ì„ íƒ)
           
        2. ì•„ì¹¨ì€ ë¹„êµì  ê°„ë‹¨í•˜ê²Œ ì œì‘í•  ìˆ˜ ìˆëŠ” ë©”ë‰´ë¡œ ì¶”ì²œí•´ ì£¼ì„¸ìš”.
            ì„¸ ë¼ì˜ ì˜ì–‘ê· í˜• ë˜í•œ ê³ ë ¤í•´ ì£¼ì„¸ìš”.
           
        3. ê·¸ ë‹¤ìŒìœ¼ë¡œ ì‚¬ìš©ìì˜ [ë‹¬ì„± ëª©í‘œ]ì™€ [ì„ í˜¸ ìŒì‹]ì„ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.
        
        4. [ì¤‘ìš”] ì‚¬ìš©ìì˜ [ë‹¬ì„± ëª©í‘œ]ì™€ [ê¸°íƒ€ ì œì•½]ì„ ë°˜ë“œì‹œ í™•ì¸í•˜ì„¸ìš”.
           - (ì˜ˆ: ëª©í‘œì— 'ë‹¤ì´ì–´íŠ¸'ê°€ ìˆë‹¤ë©´) ì¹¼ë¡œë¦¬ê°€ ë‚®ê±°ë‚˜ ê±´ê°•í•œ ì¡°ë¦¬ë²•...
           - (ì˜ˆ: ì œì•½ì— 'ì¡°ë¦¬ì‹œê°„ 30ë¶„ ì´ë‚´'ê°€ ìˆë‹¤ë©´) í›„ë³´ ëª©ë¡ì˜ 'ì†Œìš”ì‹œê°„'ì„ í™•ì¸í•˜ì—¬...
        
        5. [â˜…ë§¤ìš° ì¤‘ìš”â˜…]
           ì¶”ì²œí•˜ëŠ” 7ê°œì˜ ë ˆì‹œí”¼ ì´ë¦„ì€, [ì¶”ì²œ ëŒ€ìƒ ë ˆì‹œí”¼ í›„ë³´ ëª©ë¡]ì— ìˆëŠ” 
           '('ì™€ ')' ì‚¬ì´ì˜ (ì¡°ë¦¬ë²•: ...)ì„ ì œì™¸í•œ **ì›ë³¸ ì œëª©ê³¼ 100% ë™ì¼í•˜ê²Œ** ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤. 
           (ì˜ˆ: "- [ë‹¨í˜¸ë°• ì—ê·¸ìŠ¬ëŸ¿ ë§Œë“¤ê¸° ë‹¨í˜¸ë°• ìƒëŸ¬ë“œ ë ˆì‹œí”¼]")
           ì ˆëŒ€ ìƒˆë¡œìš´ ë ˆì‹œí”¼ ì´ë¦„ì„ ë§Œë“¤ê±°ë‚˜, ê¸°ì¡´ ì œëª©ì„ ì¤„ì—¬ì„œ ì“°ì§€ ë§ˆì„¸ìš”.
           
        6. ì¶”ì²œ ê²°ê³¼ëŠ” ì•„ë˜ [ì¶œë ¥ í˜•ì‹]ì„ ë°˜ë“œì‹œ ì§€ì¼œì£¼ì„¸ìš”.
        ì¶œë ¥ í˜•ì‹ì€ ì½ê¸° í¸í•œ **Markdown**ìœ¼ë¡œ í•´ì£¼ì„¸ìš”.

        [ì¶œë ¥ í˜•ì‹/ì•„ì¹¨í›„ë³´ 2ê°œ ì ì‹¬í›„ë³´ 2ê°œ ì €ë…í›„ë³´ 3ê°œë¡œ ì´ 7ê°œì˜ ë ˆì‹œí”¼ ì¶œë ¥]  
        ì•„ì¹¨ 1. [ë ˆì‹œí”¼ëª…]: ì´ ë ˆì‹œí”¼ë¥¼ ì¶”ì²œí•˜ëŠ” ì´ìœ  ([ì˜¤ëŠ˜ì˜ ì»¨í…ìŠ¤íŠ¸]ì™€ ì—°ê²°ì§€ì–´ ì„¤ëª…)  
        ì•„ì¹¨ 2. [ë ˆì‹œí”¼ëª…]: ì¶”ì²œ ì´ìœ   
        ...
        ì €ë… 3. [ë ˆì‹œí”¼ëª…]: ì¶”ì²œ ì´ìœ   
        """
        
        print(f"\nGemini APIì— ì¶”ì²œì„ ìš”ì²­í•©ë‹ˆë‹¤... (ëª¨ë¸: {model.model_name})")
        response = model.generate_content(prompt)
        
        return response.text

    except Exception as e:
        print(f"âŒ Gemini API ì˜¤ë¥˜: {e}")
        return None


# --- 4. [ì‹ ê·œ ì¶”ê°€] DB ì—°ë™ (ë§ˆì´í˜ì´ì§€) í•¨ìˆ˜ ---

def setup_database(conn):
    """
    (ìµœì´ˆ 1íšŒ ì‹¤í–‰) votes, rewards í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ìƒì„±í•©ë‹ˆë‹¤.
    """
    try:
        cursor = conn.cursor()
        
        # 1. 'ì¢‹ì•„ìš”/ì‹«ì–´ìš”' íˆ¬í‘œ ì €ì¥ í…Œì´ë¸”
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS votes (
            vote_id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            recipe_sno INTEGER NOT NULL,
            vote_type TEXT NOT NULL, -- 'Like' or 'Dislike'
            voted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(user_id),
            FOREIGN KEY (recipe_sno) REFERENCES recipes(RCP_SNO),
            UNIQUE(user_id, recipe_sno) -- í•œ ì‚¬ìš©ìê°€ í•œ ë ˆì‹œí”¼ì— í•œ ë²ˆë§Œ íˆ¬í‘œ
        );
        """)
        
        # 2. '7ì¼ ë‹¬ì„±' ë¦¬ì›Œë“œ ê¸°ë¡ í…Œì´ë¸”
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS rewards (
            reward_id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL UNIQUE, -- í•œ ì‚¬ìš©ìë‹¹ í•˜ë‚˜ì˜ ê¸°ë¡
            checked_count INTEGER DEFAULT 0,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        """)
        
        conn.commit()
        print("âœ… (DB ì…‹ì—…) 'votes' ë° 'rewards' í…Œì´ë¸” í™•ì¸/ìƒì„± ì™„ë£Œ.")
    except Exception as e:
        print(f"âŒ (DB ì…‹ì—…) í…Œì´ë¸” ìƒì„± ì˜¤ë¥˜: {e}")
        conn.rollback()

def save_vote(conn, user_id, recipe_sno, vote_type):
    """
    'ì¢‹ì•„ìš”' ë˜ëŠ” 'ì‹«ì–´ìš”' íˆ¬í‘œë¥¼ DBì— ì €ì¥í•©ë‹ˆë‹¤.
    (ì´ë¯¸ íˆ¬í‘œí–ˆë‹¤ë©´ ë®ì–´ì”ë‹ˆë‹¤: INSERT OR REPLACE)
    """
    query = """
    INSERT OR REPLACE INTO votes (user_id, recipe_sno, vote_type)
    VALUES (?, ?, ?)
    """
    try:
        cursor = conn.cursor()
        cursor.execute(query, (user_id, recipe_sno, vote_type))
        conn.commit()
        print(f"ğŸ—³ï¸ (DB ì €ì¥) user_id {user_id}ê°€ recipe_sno {recipe_sno}ì— '{vote_type}' íˆ¬í‘œí•¨.")
    except Exception as e:
        print(f"âŒ (DB ì €ì¥) íˆ¬í‘œ ì €ì¥ ì˜¤ë¥˜: {e}")
        conn.rollback()

def save_reward(conn, user_id, checked_count):
    """
    '7ì¼ ë‹¬ì„±' ì²´í¬ë°•ìŠ¤ ê°œìˆ˜ë¥¼ DBì— ì €ì¥(ì—…ë°ì´íŠ¸)í•©ë‹ˆë‹¤.
    """
    query = """
    INSERT OR REPLACE INTO rewards (user_id, checked_count, updated_at)
    VALUES (?, ?, CURRENT_TIMESTAMP)
    """
    try:
        cursor = conn.cursor()
        cursor.execute(query, (user_id, checked_count))
        conn.commit()
        # print(f"ğŸ† (DB ì €ì¥) user_id {user_id}ì˜ ë‹¬ì„±ë¥  {checked_count}/7 ì €ì¥.")
    except Exception as e:
        print(f"âŒ (DB ì €ì¥) ë¦¬ì›Œë“œ ì €ì¥ ì˜¤ë¥˜: {e}")
        conn.rollback()

def get_my_votes(conn, user_id):
    """
    (ë§ˆì´í˜ì´ì§€ìš©) ë‚´ê°€ 'Like'í•œ ë ˆì‹œí”¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
    """
    query = """
    SELECT r.RCP_TTL, r.CKG_MTH_ACTO_NM
    FROM votes v
    JOIN recipes r ON v.recipe_sno = r.RCP_SNO
    WHERE v.user_id = ? AND v.vote_type = 'Like'
    ORDER BY v.voted_at DESC
    """
    try:
        # read_sqlë¡œ ë°”ë¡œ DataFrameì„ ë§Œë“­ë‹ˆë‹¤.
        df = pd.read_sql(query, conn, params=(user_id,))
        return df
    except Exception as e:
        print(f"âŒ (DB ì¡°íšŒ) 'ì¢‹ì•„ìš”' ëª©ë¡ ë¡œë”© ì˜¤ë¥˜: {e}")
        return pd.DataFrame()

def get_my_rewards(conn, user_id):
    """
    (ë§ˆì´í˜ì´ì§€ìš©) ë‚˜ì˜ í˜„ì¬ 'ë‹¬ì„±' íšŸìˆ˜ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
    """
    query = "SELECT checked_count FROM rewards WHERE user_id = ?"
    try:
        cursor = conn.cursor()
        cursor.execute(query, (user_id,))
        result = cursor.fetchone() # (7,) ë˜ëŠ” None
        if result:
            return result[0] # 7
        else:
            return 0 # ê¸°ë¡ì´ ì—†ìœ¼ë©´ 0
    except Exception as e:
        print(f"âŒ (DB ì¡°íšŒ) ë¦¬ì›Œë“œ ë¡œë”© ì˜¤ë¥˜: {e}")
        return 0
    
# --- 5. [ì‹ ê·œ ì¶”ê°€]"ìŠ¤ë§ˆíŠ¸" í›„ë³´êµ° ì„ ì • (ML) ---

def _extract_ingredients_text(json_str):
    """(HELPER) ingredients_jsonì—ì„œ ì¬ë£Œëª…(key)ë§Œ ì¶”ì¶œí•´ í…ìŠ¤íŠ¸ë¡œ ë°˜í™˜"""
    try:
        ingredients_dict = json.loads(json_str)
        # ì¬ë£Œëª…(key)ë§Œ " "ìœ¼ë¡œ ë¬¶ì–´ì„œ ë°˜í™˜ (ì˜ˆ: "ë‘ë¶€ ì•„ë³´ì¹´ë„ ê°„ì¥")
        return " ".join(ingredients_dict.keys())
    except (json.JSONDecodeError, TypeError):
        return "" # íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¹ˆ í…ìŠ¤íŠ¸ ë°˜í™˜

def get_smart_candidates(profile, filtered_recipes_df, top_n=100):
    """
    (ML) TF-IDFì™€ ì½”ì‚¬ì¸ ìœ ì‚¬ë„ë¥¼ ì‚¬ìš©í•´
    ì‚¬ìš©ì í”„ë¡œí•„ê³¼ ê°€ì¥ ìœ ì‚¬í•œ 'ì·¨í–¥ ì €ê²©' ë ˆì‹œí”¼ top_nê°œë¥¼ ë°˜í™˜
    """
    print(f"ğŸ¤– (ML) 'ì·¨í–¥ ì €ê²©' í›„ë³´êµ° ì„ ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤... (ëŒ€ìƒ: {len(filtered_recipes_df)}ê°œ)")
    
    # 1. ì‚¬ìš©ì í”„ë¡œí•„ í…ìŠ¤íŠ¸ ìƒì„± (ë¹„êµ ê¸°ì¤€)
    # (ê¸°í˜¸ + ëª©í‘œ)
    user_text = profile['preferences'] + " " + profile['goals']
    # ì˜ˆ: "í•œì‹, ì¼ì‹, ì±„ì†Œ ë‹¤ì´ì–´íŠ¸, ì €ì—¼ì‹"
    
    # 2. ë ˆì‹œí”¼ ì¬ë£Œ í…ìŠ¤íŠ¸ ìƒì„± (ë¹„êµ ëŒ€ìƒ)
    # (ì´ ì‘ì—…ì€ ìˆ˜ì²œ~ìˆ˜ë§Œ ê±´ì´ë¯€ë¡œ ì‹œê°„ì´ ì¡°ê¸ˆ ê±¸ë¦´ ìˆ˜ ìˆìŒ)
    recipe_texts = filtered_recipes_df['ingredients_json'].apply(_extract_ingredients_text)
    
    if recipe_texts.empty:
        print("âš ï¸ (ML) ì¬ë£Œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëœë¤ ìƒ˜í”Œë§ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.")
        sample_size = min(top_n, len(filtered_recipes_df))
        return filtered_recipes_df.sample(n=sample_size, random_state=42)
        
    # 3. TF-IDF ë²¡í„°í™”
    try:
        vectorizer = TfidfVectorizer()
        
        # 3-1. ë ˆì‹œí”¼(ì¬ë£Œ) ì „ì²´ë¡œ TF-IDF ì–´íœ˜ ì‚¬ì „ í•™ìŠµ
        tfidf_matrix_recipes = vectorizer.fit_transform(recipe_texts)
        
        # 3-2. ì‚¬ìš©ì í”„ë¡œí•„ í…ìŠ¤íŠ¸ë¥¼ ë™ì¼í•œ ì–´íœ˜ ì‚¬ì „ìœ¼ë¡œ ë³€í™˜
        tfidf_vector_user = vectorizer.transform([user_text])
        
        # 4. ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê³„ì‚°
        # (ê²°ê³¼ shape: [1, num_recipes])
        cosine_sims = cosine_similarity(tfidf_vector_user, tfidf_matrix_recipes)
        
        # 5. ìœ ì‚¬ë„ ì ìˆ˜ê°€ ê°€ì¥ ë†’ì€ top_nê°œì˜ *ì¸ë±ìŠ¤* ì°¾ê¸°
        # [0]ìœ¼ë¡œ 1D ë°°ì—´ë¡œ ë§Œë“¤ê³ , argsortë¡œ ì •ë ¬ í›„, ìƒìœ„ top_nê°œ ì„ íƒ
        # (ìœ ì‚¬ë„ê°€ 0ì¸ ë ˆì‹œí”¼ê°€ ë§ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì‹¤ì œ ê°œìˆ˜(len)ì™€ top_n ì¤‘ ì‘ì€ ê°’ì„ íƒí•¨)
        num_candidates = min(top_n, len(cosine_sims[0]))
        top_indices = np.argsort(cosine_sims[0])[-num_candidates:][::-1]
        
        # 6. ìƒìœ„ top_nê°œ ë ˆì‹œí”¼ DataFrame ë°˜í™˜
        smart_candidates_df = filtered_recipes_df.iloc[top_indices]
        
        print(f"âœ… (ML) 'ì·¨í–¥ ì €ê²©' í›„ë³´êµ° {len(smart_candidates_df)}ê°œ ì„ ì • ì™„ë£Œ.")
        return smart_candidates_df
        
    except Exception as e:
        print(f"âŒ (ML) TF-IDF/ìœ ì‚¬ë„ ê³„ì‚° ì‹¤íŒ¨: {e}. ëœë¤ ìƒ˜í”Œë§ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.")
        sample_size = min(top_n, len(filtered_recipes_df))
        return filtered_recipes_df.sample(n=sample_size, random_state=42)
    
# -----------------------------------------------------------------
# [ì‹ ê·œ ì¶”ê°€] 1ìˆœìœ„: AI ë ˆì‹œí”¼ ë³€í˜• (Generative AI)
# -----------------------------------------------------------------

def modify_recipe_with_gemini(api_key, recipe_title, ingredients_json, modification_request):
    """
    (GenAI) ì›ë³¸ ë ˆì‹œí”¼ë¥¼ ì‚¬ìš©ìì˜ ìš”ì²­(ì˜ˆ: ì €ì—¼ì‹, 1ì¸ë¶„)ì— ë§ì¶° ë³€í˜•í•˜ì—¬ ìƒì„±í•©ë‹ˆë‹¤.
    """
    try:
        genai.configure(api_key=api_key)
        model = genai.GenerativeModel('models/gemini-flash-latest')
        
        # ì›ë³¸ ì¬ë£Œ íŒŒì‹± (ë¬¸ìì—´ -> ë³´ê¸° ì¢‹ì€ í…ìŠ¤íŠ¸)
        try:
            ing_dict = json.loads(ingredients_json)
            ingredients_str = ", ".join([f"{k} {v}" for k, v in ing_dict.items()])
        except:
            ingredients_str = ingredients_json

        # [í”„ë¡¬í”„íŠ¸ ì‘ì„±]
        prompt = f"""
        ë‹¹ì‹ ì€ ì°½ì˜ì ì´ê³  ìœ ëŠ¥í•œ ìš”ë¦¬ ì—°êµ¬ê°€ì…ë‹ˆë‹¤.
        ì•„ë˜ì˜ [ì›ë³¸ ë ˆì‹œí”¼]ë¥¼ ì‚¬ìš©ìì˜ [ìš”ì²­ ì‚¬í•­]ì— ë§ì¶° **ìƒˆë¡­ê²Œ ë³€í˜•**í•´ì£¼ì„¸ìš”.

        [ì›ë³¸ ë ˆì‹œí”¼ ì •ë³´]
        - ìš”ë¦¬ëª…: {recipe_title}
        - ì›ë³¸ ì¬ë£Œ: {ingredients_str}

        [ì‚¬ìš©ì ìš”ì²­ ì‚¬í•­]
        ğŸ‘‰ "{modification_request}"

        [ì‘ì„± ê°€ì´ë“œ]
        1. ìš”ì²­ ì‚¬í•­ì„ ë°˜ì˜í•˜ì—¬ **ë³€ê²½ëœ ì¬ë£Œ ëª©ë¡**ì„ ì‘ì„±í•˜ì„¸ìš”. (ì˜ˆ: 1ì¸ë¶„ì´ë©´ ì–‘ì„ ì¤„ì´ê³ , ì €ì—¼ì‹ì´ë©´ ê°„ì¥ì„ ì¤„ì´ê±°ë‚˜ ëŒ€ì²´)
        2. ë³€í˜•ëœ ë ˆì‹œí”¼ë¡œ ìš”ë¦¬í•˜ëŠ” **ê°„ë‹¨í•œ ì¡°ë¦¬ë²•(Step-by-Step)**ì„ 3~5ë‹¨ê³„ë¡œ ìš”ì•½í•´ì„œ ì‘ì„±í•˜ì„¸ìš”.
        3. ë§ˆì§€ë§‰ì— ì´ ë³€í˜•ì´ ì™œ ì¢‹ì€ì§€ **'ì˜ì–‘ì‚¬ì˜ í•œë§ˆë””'**ë¥¼ ë§ë¶™ì—¬ì£¼ì„¸ìš”.
        4. ì¶œë ¥ í˜•ì‹ì€ ì½ê¸° í¸í•œ **Markdown**ìœ¼ë¡œ í•´ì£¼ì„¸ìš”.
        """
        
        print(f"ğŸ¤– (GenAI) ë ˆì‹œí”¼ ë³€í˜• ìš”ì²­: {recipe_title} -> {modification_request}")
        response = model.generate_content(prompt)
        return response.text

    except Exception as e:
        print(f"âŒ (GenAI) ë ˆì‹œí”¼ ë³€í˜• ì‹¤íŒ¨: {e}")
        return None
    
# --- 6. ë©”ì¸ ì½”ë“œ ì‹¤í–‰(api í˜¸ì¶œ í…ŒìŠ¤íŠ¸ìš©) ---

if __name__ == "__main__":
    
    if "YOUR_API_KEY" in YOUR_API_KEY:
        print("="*50)
        print("âŒ ì˜¤ë¥˜: ìŠ¤í¬ë¦½íŠ¸ 10ì¤„ì˜ YOUR_API_KEYë¥¼")
        print("Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ ë³¸ì¸ì˜ í‚¤ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.")
        print("="*50)
        exit()

    conn = None
    try:
        conn = sqlite3.connect(DB_PATH)
        print(f"'{DB_PATH}' ì—°ê²° ì„±ê³µ.")
        
        # [1ë‹¨ê³„] ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ (TARGET_USER_ID ê¸°ì¤€)
        profile = get_user_profile(conn, TARGET_USER_ID)
        if not profile:
            exit()
            
        print(f"\n--- {profile['username']}ë‹˜(ID:{TARGET_USER_ID})ì„ ìœ„í•œ ì¶”ì²œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ---")
        print(f"ëª©í‘œ: {profile['goals']} | ì„ í˜¸: {profile['preferences']}")
        
        # [2ë‹¨ê³„] 1ì°¨ í•„í„°ë§ (ì œì•½ ì¡°ê±´ + ì‹œê°„)
        restrictions = parse_restrictions(profile)
        # (ìˆ˜ì •) profile ê°ì²´ë„ í•¨ê»˜ ì „ë‹¬
        filtered_recipes = recommend_recipes_by_filter(conn, profile, restrictions)
        
        if filtered_recipes.empty:
            print("í•„í„°ë§ ê²°ê³¼, ì¶”ì²œí•  ìˆ˜ ìˆëŠ” ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
        else:
            # [3ë‹¨ê³„] 2ì°¨ ì¶”ì²œ (Gemini API)
            
            # 100ê°œ ìƒ˜í”Œë§
            sample_size = min(100, len(filtered_recipes))
            candidate_recipes = filtered_recipes.sample(n=sample_size, random_state=42)
            print(f"âœ… (2ì°¨) {len(candidate_recipes)}ê°œ ë ˆì‹œí”¼ë¥¼ ìƒ˜í”Œë§í•˜ì—¬ AI í›„ë³´ë¡œ ì„ ì •.")
            
            # [4ë‹¨ê³„] AI í˜¸ì¶œ
            recommendation_text = get_gemini_recommendation(
                YOUR_API_KEY, 
                profile, 
                candidate_recipes
            )
            
            if recommendation_text:
                print("\n" + "="*25)
                print(f"  Gemini APIê°€ ì¶”ì²œí•˜ëŠ”")
                print(f" '{profile['username']}' ë‹˜ì„ ìœ„í•œ ì£¼ê°„ ì‹ë‹¨")
                print("="*25)
                print(recommendation_text)

    except Exception as e:
        print(f"ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì˜¤ë¥˜: {e}")
        
    finally:
        if conn:
            conn.close()
            print(f"\n'{DB_PATH}' ì—°ê²° ì¢…ë£Œ.")